<app-header [showOutings]="true"></app-header>

<!-- Top: Signed in as -->
<section class="card signed-as">
  <div class="top-row">
    <span class="muted">Signed in as</span>
    <span class="name">{{ fullName() || initial() }}</span>
  </div>
  <div class="email-row">
    <span class="email">{{ email() }}</span>
  </div>
</section>

<!-- Bottom: Two columns -->
<section class="card two-col">
  <!-- Left: Avatar + Change -->
  <div class="col left">
    <div class="avatar-wrap">
      <img *ngIf="avatarUrl; else placeholder" [src]="avatarUrl" class="avatar-xl" alt="Avatar" />
      <ng-template #placeholder>
        <div class="avatar-xl placeholder">{{ initial() }}</div>
      </ng-template>
    </div>

    <input #fileInput type="file" accept="image/*" hidden (change)="onFileChange($event)" />
    <button class="btn dark full" (click)="openPicker(fileInput)">Change</button>
    <small class="hint">PNG, JPG, or WEBP · Max 5 MB</small>
  </div>

  <!-- Right: Description -->
  <div class="col right">
    <div class="about-header">
      <h2>About Me</h2>
      <button *ngIf="!editingBio()" class="btn dark" (click)="startEditBio()">Edit</button>
    </div>

    <!-- View mode -->
    <div *ngIf="!editingBio(); else editBioTpl" class="desc-box">
      <p *ngIf="about(); else emptyBio">{{ about() }}</p>
      <ng-template #emptyBio>
        <p class="empty-text">Nothing here yet. Click Edit to add a short bio.</p>
      </ng-template>
    </div>

    <!-- Edit mode -->
    <ng-template #editBioTpl>
      <div class="desc-box">
        <textarea
          class="bio-input"
          [value]="tempBio()"
          (input)="tempBio.set(($any($event.target).value || '').slice(0, 500))"
          placeholder="Write a short bio… (max 500 chars)"
          rows="5"
          maxlength="500"
        ></textarea>

        <div class="muted small mt-6">{{ tempBio().length }}/500</div>

        <div class="actions">
          <button class="btn light" [disabled]="savingBio()" (click)="saveBio()">Save</button>
          <button class="btn light" [disabled]="savingBio()" (click)="cancelEditBio()">
            Cancel
          </button>
        </div>
      </div>
    </ng-template>

    <!-- Preferences (kept below About) -->
    <h2 class="mt-pref">Preferences</h2>

    <div class="prefs-box">
      <!-- Chips -->
      <div class="chips" *ngIf="preferences().length; else noPrefs">
        <span class="chip" *ngFor="let p of preferences(); let i = index">
          {{ p }}
          <button class="x" (click)="removePref(i)" aria-label="Remove">×</button>
        </span>
      </div>
      <ng-template #noPrefs>
        <div class="empty-text">No preferences yet. Add a few below.</div>
      </ng-template>

      <!-- Add input -->
      <div class="add-row">
        <input
          #prefInput
          class="pref-input"
          type="text"
          placeholder="Type a preference and press save"
          (keydown.enter)="addPref(prefInput.value); prefInput.value = ''"
          maxlength="40"
        />
        <button class="btn dark" (click)="addPref(prefInput.value); prefInput.value = ''">
          Add
        </button>
      </div>

      <!-- Save -->
      <div class="actions">
        <button class="btn dark full" (click)="savePrefs()">Save Preferences</button>
      </div>
    </div>

    <section>
      <h2>Profile History</h2>
      <button (click)="loadProfileHistory()">Load History</button>
      <ul *ngIf="!loadingProfileHistory()">
        <li *ngFor="let ver of profileHistory()">
          <p>Version from {{ ver.history_timestamp }} ({{ ver.history_operation }})</p>
          <p>Bio preview: {{ ver.bio?.substring(0, 50) || 'None' }}...</p>
          <!-- Add more previews as needed -->
          <button (click)="restoreProfileVersion(ver.history_id)">Restore</button>
        </li>
      </ul>
      <p *ngIf="loadingProfileHistory()">Loading...</p>
    </section>
  </div>
</section>
